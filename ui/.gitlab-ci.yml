unit test ui:
  only:
    changes:
      - ui/**/*
  stage: test
  image: node:10.16.0@sha256:523f767f8907f002316d3334bdb9d1154c7c6f6157c7aed3de5305726a963616
  before_script:
    - cd ui
    - yarn install
  script:
    - yarn run test:unit --coverage --coverageReporters=cobertura
    - yarn run lint --no-fix --max-warnings 0
  cache:
    key: "${CI_COMMIT_REF_NAME}_ui"
    policy: pull-push
    paths:
      - ui/node_modules/
  artifacts:
    reports:
      cobertura: ui/coverage/cobertura-coverage.xml

build ui for production:
  only:
    changes:
      - ui/**/*
  needs:
    - unit test ui
  stage: build
  image: node:10.16.0@sha256:523f767f8907f002316d3334bdb9d1154c7c6f6157c7aed3de5305726a963616
  before_script:
    - cd ui
    - yarn install
  script:
    - yarn run build
  cache:
    key: "${CI_COMMIT_REF_NAME}_ui"
    policy: pull
    paths:
      - node_modules/
      - .yarn

build ui image:
  extends: .docker-build
  variables:
    SERVICE_FOLDER: ui
  only:
    changes:
      - ui/**/*
  needs:
    - build ui for production

publish ui image:
  extends: .docker-publish
  only:
    changes:
      - ui/**/*
  needs:
    - build ui image
  variables:
    DOCKER_HUB_REGISTRY_IMAGE: $DOCKER_HUB_REGISTRY_ORG/ui
