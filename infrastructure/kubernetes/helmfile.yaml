repositories:
  - name: codecentric
    url: https://codecentric.github.io/helm-charts

environments:
  default:
  istio:
  linkerd:

releases:
  - name: ui
    namespace: hc-ui
    chart: ../hc-ui/helm/ui
    values:
      - ./helmfile-templates/ui-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite" ]
      {{- end }}
      {{- if eq .Environment.Name "linkerd" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "annotate", "ns", "{{`{{ .Release.Namespace }}`}}", "linkerd.io/inject=enabled", "--overwrite" ]
      {{- end }}
  - name: habit
    namespace: hc-habit
    chart: ../hc-habit/helm/habit
    values:
      - ./helmfile-templates/habit-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite"]
      {{- end }}
      {{- if eq .Environment.Name "linkerd" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "annotate", "ns", "{{`{{ .Release.Namespace }}`}}", "linkerd.io/inject=enabled", "--overwrite" ]
      {{- end }}
  - name: track
    namespace: hc-track
    chart: ../hc-track/helm/track
    values:
      - ./helmfile-templates/track-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite" ]
      {{- end }}
      {{- if eq .Environment.Name "linkerd" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "annotate", "ns", "{{`{{ .Release.Namespace }}`}}", "linkerd.io/inject=enabled", "--overwrite" ]
      {{- end }}
  - name: report
    namespace: hc-report
    chart: ../hc-report/helm/report
    values:
      - ./helmfile-templates/report-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite" ]
      {{- end }}
      {{- if eq .Environment.Name "linkerd" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "annotate", "ns", "{{`{{ .Release.Namespace }}`}}", "linkerd.io/inject=enabled", "--overwrite" ]
      {{- end }}
  - name: keycloak
    namespace: hc-keycloak
    chart: codecentric/keycloak
    values:
      - ./helmfile-templates/keycloak-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite" ]
      {{- end }}
      {{- if eq .Environment.Name "linkerd" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "annotate", "ns", "{{`{{ .Release.Namespace }}`}}", "linkerd.io/inject=enabled", "--overwrite" ]
      {{- end }}
  - name: lpt-locust
    namespace: hc-lpt-locust
    chart: ../hc-lpt-locust/helm/lpt-locust
    values:
      - ./helmfile-templates/lpt-locust-values.yaml.gotmpl
  {{- if eq .Environment.Name "default" }}
  - name: gateway
    namespace: hc-gateway
    chart: ../hc-gateway/helm/gateway
    values:
      - ./helmfile-templates/gateway-values.yaml.gotmpl
  {{- end }}  
  
