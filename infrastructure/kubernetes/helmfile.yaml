repositories:
  - name: codecentric
    url: https://codecentric.github.io/helm-charts

environments:
  default:
  istio:

releases:
  - name: ui
    namespace: hc-ui
    chart: ../hc-ui/k8s/helm/ui
    values:
      - ./helmfile-templates/ui-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite" ]
      {{- end }}
  - name: habit
    namespace: hc-habit
    chart: ../hc-habit/k8s/helm/habit
    values:
      - ./helmfile-templates/habit-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite"]
      {{- end }}
  - name: track
    namespace: hc-track
    chart: ../hc-track/k8s/helm/track
    values:
      - ./helmfile-templates/track-values.yaml.gotmpl
    hooks:
      {{- if eq .Environment.Name "istio" }}     
      - events: [ "presync" ]
        command: "sh"
        args: [ "-c", "kubectl create namespace {{`{{ .Release.Namespace }}`}} --dry-run -o yaml | kubectl apply -f -" ]
      - events: [ "presync" ]
        command: "kubectl"
        args: [ "label", "ns", "{{`{{ .Release.Namespace }}`}}", "istio-injection=enabled", "--overwrite" ]
      {{- end }}
  {{- if ne .Environment.Name "istio" }}
  - name: gateway
    namespace: hc-gateway
    chart: ../hc-gateway/k8s/helm/gateway
    values:
      - ./helmfile-templates/gateway-values.yaml.gotmpl
  {{- end }}  
  
